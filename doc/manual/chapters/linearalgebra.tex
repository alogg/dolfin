\chapter{Linear algebra}

\devnote{This chapter is currently being written\ldots}

\dolfin{} does not have its own linear algebra routines,
but instead uses the external packages PETSc \cite{www:petsc}
and uBLAS \cite{www:ublas} for linear algebra functionality.

PETSc is a suite of data structures and routines for the scalable
(parallel) solution of scientific applications modeled by partial
differential equations.
It employs the MPI standard for all message-passing communication.

uBLAS is a C++ template class library that provides BLAS level 1, 2, 3
functionality for dense, packed and sparse matrices.
The design and implementation unify mathematical notation via operator
overloading and efficient code generation via expression templates.

For convenience \dolfin{} provides wrappers for some of the most
common linear algebra functionality of PETSc and uBLAS.
For more advanced usage,
\dolfin{} provides direct access to the PETSc/uBLAS pointers
to be used with the standard PETSc/uBLAS interfaces.


\section{PETSc}

\section{uBLAS}

uBLAS provides templated C++ classes for dense, unit and sparse vectors,
dense, identity, triangular, banded, symmetric, hermitian and sparse matrices. 
Views into vectors and matrices can be constructed via ranges or slices and 
adaptor classes. The library covers the usual basic linear algebra operations on
vectors and matrices: reductions like different norms, addition and subtraction 
of vectors and matrices and multiplication with a scalar, inner and outer 
products of vectors, matrix vector and matrix matrix products and triangular 
solver. The glue between containers, views and expression templated operations 
is a mostly STL conforming iterator interface.



\section{Matrices and Vectors}

\dolfin{} differs between sparse and dense data structures, but provide
the classes \texttt{GenericMatrix} and \texttt{GenericVector}, that define
common matrix and vector interfaces for sparse and dense data structures.

The default type \texttt{DenseMatrix} is \texttt{uBlasDenseMatrix} and
the default type \texttt{SparseMatrix} is \texttt{PETScMatrix} if
PETSc is enables, and otherwise \texttt{uBlasSparseMatrix}.
The corresponding vector default types are defined similarly.

The default types \texttt{Matrix} and \texttt{Vector} are set
to \texttt{SparseMatrix} and \texttt{SparseVector}.

\texttt{uBlasDenseMatrix} and \texttt{uBlasSparseMatrix} have
a common implementation in \texttt{uBLASMatrix}, which is a wrapper
for a Boost uBLAS matrix of type \texttt{Mat}.
The intention is to provide a uniform interface with respect to other
matrix data types in \dolfin().
For advanced usage, refer to the documentation for
uBLAS which can be found at \cite{www:ublas}.

\texttt{PETScMatrix} is a simple wrapper for the PETSc matrix
pointer \texttt{Mat}. Again the interface is intentionally simple.
For advanced usage, access the PETSc Mat pointer using the function
\texttt{mat()} and use the standard PETSc interface
\texttt{petsc:www}.
For parallel matrices, the PETSc interface has to be used directly.

Similarly, \texttt{PETScVector} and \texttt{uBLASVector} are
simple wrappers of the PETSc vector pointer \texttt{Vec} and
the Boost ublas \texttt{vector}.

% class diagram

\section{Matrix-free matrices}

The \dolfin{} class \texttt{VirtualMatrix} represents a matrix-free 
matrix of dimension $M\times M$. 
The matrix-free matrix is a simple wrapper for a PETSc shell matrix. 
The interface is intentionally simple, and for advanced usage the 
PETSc \texttt{Mat} pointer is accessed by the function \texttt{mat()}.  

The class \texttt{VirtualMatrix} enables the use of Krylov subspace
methods for linear systems $Ax = b$, without having to explicitly
store the matrix $A$. All that is needed is that the user-defined
\texttt{VirtualMatrix} implements multiplication with vectors. 
Note that the multiplication operator needs to be defined in terms of
PETSc data structures (\texttt{Vec}), since it will be called from PETSc.

\section{Linear solvers}

A general interface to all linear solvers for systems of the form 
$Ax=b$ is provided through the class \texttt{LinearSolver}. 

In particular, wrappers for a direct LU solver and an iterative 
Krylov GMRES solver are implemented in the classes \texttt{LU} and \texttt{GMRES}. 

To solve the linear system $Ax=b$ using GMRES in \dolfin{}, simply write:  
%
\begin{code} 
Vec x;
GMRES solver; 
solver.solve(A,x,b);
\end{code} 
%
\dolfin{} also provides a wrapper for an eigenvalue 
solver\index{eigenvalue solver} in PETSc. The following code computes the 
eigenvalues of the matrix $A$,
\begin{code} 
Vector er, ec;
EigenvalueSolver esolver; 
esolver.eigen(A,er,ec);
\end{code} 
The real components of the eigenvalues are returned in the vector \texttt{er} and
the complex components of the eigenvalues are returned in the vector \texttt{ec}.
The procedure for computing the eigenvalues of a matrix is computationally 
intensive and should only be used for relatively small matrices.


\section{Preconditioning}

The \texttt{Preconditioner} class specifies the interface for user-defined 
Krylov method preconditioners. To implement our own preconditioner we only 
need to supply a function that approximately solves the linear system given 
a right-hand side.

To change the default preconditioner in the \dolfin{} GMRES solver, edit the 
constructor of the \texttt{GMRES} class. For example, to choose the 
ILU preconditioner for GMRES we write 
%
\begin{code}
PC pc;
KSPGetPC(ksp, &pc);
PCSetType(pc, PCILU);
\end{code}

As a complement to the preconditioners available in PETSc, 
\dolfin{} also uses Hypre \cite{www:hypre}, which is a 
library for solving large, sparse linear systems of equations on 
massively parallel computers. 

To use a preconditioner from Hypre together with a PETSc solver in \dolfin{}, we write:  
%
\begin{code}
PCSetType(pc, PCHYPRE );
PCHYPRESetType(pc,"boomeramg");
\end{code}

In particular, the above preconditioner \texttt{boomeramg} is an algebraic multigrid 
preconditioner, which is very useful. 

\begin{figure}
  \begin{center}
    \includegraphics[width=0.95\textwidth]{eps/class-diagram-la.eps}
    \caption{Class diagram of the linear algebra classes in \dolfin{}.}
    \label{fig:laclasses}
  \end{center}
\end{figure}
